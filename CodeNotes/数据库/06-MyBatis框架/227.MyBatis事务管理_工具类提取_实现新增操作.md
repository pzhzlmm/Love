# 227.MyBatis事务管理_工具类提取_实现新增操作

<a name="4a731dbb"></a>
# 1.增删改DML操作 
<a name="b0f4e7c2"></a>
## 事务(Transaction)
a) 事务是数据库操作的最小单元, 有 ACID 的特性. 应该保证一个事务的的 SQL 语句要么同时成功, 要么都不成功.<br />b) MyBatis 中配置了事务管理器, type 属性设置为 JDBC.表示 MyBatis 采用和原生 JDBC 相同的事务管理机制.<br />c) 在 MyBatis 执行的开始时,将自动提交功能关闭了.所以,在执行 DML 操作时, 需要手动提交事务.
<a name="36d46e72"></a>
## 2. 简单提取工具类
package com.bjsxt.util;<br />import java.io.IOException;<br />import java.io.InputStream;<br />import org.apache.ibatis.io.Resources;<br />import org.apache.ibatis.session.SqlSession;<br />import org.apache.ibatis.session.SqlSessionFactory;<br />import org.apache.ibatis.session.SqlSessionFactoryBuilder;<br />public class MyBatisUtil {<br />private static SqlSessionFactory factory = null;<br />static {<br />try {<br />InputStream is =<br />Resources.getResourceAsStream("mybatis-cfg.xml");<br />factory = new SqlSessionFactoryBuilder().build(is);<br />} catch (IOException e) {<br />e.printStackTrace();<br />}<br />}<br />public static SqlSession getSession() {<br />SqlSession session = null;<br />if (factory != null) {<br />// true表示开启自动提交<br />// session = factory.openSession(true);<br />session = factory.openSession();<br />}<br />return session;<br />}<br />}
<a name="7ef28cca"></a>
## 3. 新增(insert)
mapper 文件中, 通过<insert>定义新增语句. 注意, 由于DML 操作的返回值都是 int 类型, 所以, 不需要定义resultType 属性.
<a name="ee7e7f0e"></a>
### <!-- 新增 -->
分析<br />parameterType="user":别名已经起了<br />insert into t_user values (default, #{username}, #{password}) default,id自动增长#{}属性名<br />编写测试类可以发现又是一堆套路<br />![](https://cdn.nlark.com/yuque/0/2019/png/349894/1561544390516-c1067679-9b78-43a7-b92b-fb69bf363565.png#align=left&display=inline&height=298&originHeight=685&originWidth=1908&status=done&width=831)<br />所以趁此我们提取下工具类<br />提供一些静态方法来获取session(增删改都是通过session去操作的)<br />工厂只需要有一个就够了,不需要每次创建session的时候都取创建工厂,因此声明为静态成员变量,在静态代码块之中进行创建<br />![](https://cdn.nlark.com/yuque/0/2019/png/349894/1561544390651-9b6a0964-5a21-4442-a8d8-793cd46e9e65.png#align=left&display=inline&height=281&originHeight=649&originWidth=1919&status=done&width=831)<br />建立好工厂之后再通过工厂造session<br />![](https://cdn.nlark.com/yuque/0/2019/png/349894/1561544390735-7367c0e9-a330-4d8e-a526-f4f333cf5477.png#align=left&display=inline&height=196&originHeight=220&originWidth=640&status=done&width=570)<br />使用<br />![](https://cdn.nlark.com/yuque/0/2019/png/349894/1561544390825-2959455c-9036-49fe-a39e-a97edbd82c60.png#align=left&display=inline&height=334&originHeight=740&originWidth=1843&status=done&width=831)<br />![](https://cdn.nlark.com/yuque/0/2019/png/349894/1561544390909-32a6a4f5-a891-467a-9127-4cfafb740b04.png#align=left&display=inline&height=67&originHeight=77&originWidth=588&status=done&width=514)<br />结果<br />![](https://cdn.nlark.com/yuque/0/2019/png/349894/1561544390981-deedc197-8948-428f-984d-c71ba06aacab.png#align=left&display=inline&height=201&originHeight=230&originWidth=949&status=done&width=831)<br />实际上没有插入成功<br />![](https://cdn.nlark.com/yuque/0/2019/png/349894/1561544391057-11dee9e6-e8a4-465f-9e68-abae0f3e5824.png#align=left&display=inline&height=246&originHeight=269&originWidth=907&status=done&width=831)

![](https://cdn.nlark.com/yuque/0/2019/png/349894/1561544391130-03674702-d522-4706-a124-d95eaf7ec14d.png#align=left&display=inline&height=586&originHeight=547&originWidth=666&status=done&width=713)<br />相当于数据回滚了<br />把我们所有代码调成debug就能看到<br />![](https://cdn.nlark.com/yuque/0/2019/png/349894/1561544391215-10355d10-78dd-461b-991a-e9ba096818c2.png#align=left&display=inline&height=139&originHeight=190&originWidth=1138&status=done&width=831)<br />因此要设置提交事务与回滚事务<br />![](https://cdn.nlark.com/yuque/0/2019/png/349894/1561544391286-d553b7c1-31dd-454c-963c-305c60c51c4f.png#align=left&display=inline&height=375&originHeight=322&originWidth=713&status=done&width=831)<br />这次可以看出来提交成功了<br />![](https://cdn.nlark.com/yuque/0/2019/png/349894/1561544391359-8b7cf70c-dbac-4b04-8420-7a06abe24c38.png#align=left&display=inline&height=216&originHeight=300&originWidth=1154&status=done&width=831)<br />还有一种方法是让事务自动提交,Jdbc本身是自动提交事务,在创建session对象的时候把自动提交给关掉了,现在再把它不关这个事务就可以了<br />![](https://cdn.nlark.com/yuque/0/2019/png/349894/1561544391427-71ebc924-bb11-4115-9b69-eba37c35acd5.png#align=left&display=inline&height=248&originHeight=234&originWidth=785&status=done&width=831)<br />这里有个boolean值,即是否开启自动事务提交,默认为false,给它改成true就可以了<br />如果说有一条事务自动提交无所谓,但是如果事务多了就没办法控制其成功与失败,就不建议设定为自动事务提交了,这样并不安全<br />源码<br /><insert id="insUser" parameterType="user"><br />insert into t_user values (default, #{username}, #{password})<br /></insert><br />@Test<br />public void testIns() {<br />SqlSession session = MyBatisUtil.getSession();<br />User user = new User();<br />user.setUsername("小明");<br />user.setPassword("123");<br />int num = session.insert("com.bjsxt.mapper.UserMapper.insUser",user);<br />if(num > 0) {<br />// 提交事务<br />session.commit();<br />System.out.println("SUCCESS!");<br />} else {<br />// 回滚事务<br />session.rollback();<br />System.out.println("FAILED!");<br />}
<a name="f1d0022e"></a>
### // 关闭资源
session.close();<br />}
